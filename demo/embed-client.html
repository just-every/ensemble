<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ensemble Embed Demo</title>
    <style>
        :root {
            --primary: #1a73e8;
            --primary-dark: #1557b0;
            --success: #34a853;
            --warning: #fbbc04;
            --error: #ea4335;
            --background: #f5f5f5;
            --surface: #ffffff;
            --text: #202124;
            --text-secondary: #5f6368;
            --code-bg: #f8f9fa;
            --border: #e0e0e0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        h1 {
            color: var(--primary);
            margin-bottom: 0;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 28px;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .generate-code-btn {
            background: var(--surface);
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .generate-code-btn:hover {
            background: var(--primary);
            color: white;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--surface);
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        .modal-tabs-section {
            border-bottom: 1px solid var(--border);
            background: var(--surface);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            margin: 0;
            font-size: 20px;
            color: var(--text);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f0f0f0;
            color: var(--text);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .code-tabs {
            display: flex;
            gap: 8px;
            padding: 0 24px;
        }

        .code-tab {
            background: none;
            border: none;
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            border-radius: 0;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .code-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .code-container {
            position: relative;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            overflow-x: auto;
        }

        .code-container pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .copy-button {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-button:hover {
            background: var(--primary-dark);
        }

        .copy-button.copied {
            background: var(--success);
        }

        h2 {
            margin-bottom: 16px;
            color: var(--text);
            font-size: 20px;
        }

        h3 {
            margin-bottom: 12px;
            color: var(--text);
            font-size: 16px;
        }

        .status-section {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 16px;
            font-weight: 500;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e0e0e0;
            transition: all 0.3s;
        }

        .status.connected .status-indicator {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .status.connecting .status-indicator {
            background: var(--warning);
            animation: pulse 1s infinite;
        }

        .status.error .status-indicator {
            background: var(--error);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.2); }
        }

        .input-section {
            margin-bottom: 20px;
        }

        .text-inputs {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .text-input-wrapper {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .primary-btn {
            background: var(--primary);
            color: white;
        }

        .primary-btn:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .secondary-btn {
            background: #e8e8e8;
            color: var(--text);
        }

        .secondary-btn:hover:not(:disabled) {
            background: #d8d8d8;
        }

        .danger-btn {
            background: var(--error);
            color: white;
        }

        .danger-btn:hover:not(:disabled) {
            background: #c5221f;
        }

        .icon-btn {
            padding: 8px;
            background: transparent;
            color: var(--text-secondary);
        }

        .icon-btn:hover {
            background: var(--code-bg);
            color: var(--text);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .setting-label {
            font-weight: 500;
            font-size: 14px;
            color: var(--text-secondary);
        }

        select {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            background-color: var(--surface);
            cursor: pointer;
            transition: border-color 0.2s;
        }

        select:hover {
            border-color: #c0c0c0;
        }

        select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 16px 0;
            display: none;
        }

        .progress-bar.active {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0;
            transition: width 0.3s ease;
        }

        .embeddings-list {
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .embedding-item {
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .embedding-item:hover {
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .embedding-item.selected {
            border-color: var(--primary);
            background: #e8f0fe;
        }

        .embedding-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .embedding-text {
            font-weight: 500;
            color: var(--text);
        }

        .embedding-meta {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .embedding-preview {
            font-family: monospace;
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
        }

        .search-section {
            margin-bottom: 20px;
        }

        .search-input-wrapper {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .search-results {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .result-item {
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .similarity-score {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .similarity-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .similarity-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
        }

        .analysis-section {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 16px;
        }

        .analysis-content {
            white-space: pre-wrap;
            font-family: inherit;
            line-height: 1.6;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .examples-section {
            margin-top: 20px;
            padding: 16px;
            background: #e8f0fe;
            border-radius: 8px;
        }

        .example-btn {
            padding: 8px 16px;
            margin: 4px;
            background: white;
            border: 1px solid var(--primary);
            color: var(--primary);
            font-size: 14px;
        }

        .example-btn:hover {
            background: var(--primary);
            color: white;
        }

        .error-message {
            background: #fce8e6;
            color: var(--error);
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .server-url-container {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .server-url-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            margin-top: 8px;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-card">
            <div class="header-row">
                <h1>
                    <svg width="32" height="32" viewBox="0 0 448 512" fill="currentColor">
                        <path d="M160 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96zM32 320c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM352 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 320c-17.7 0-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-96 0z"/>
                    </svg>
                    Ensemble Embed Demo
                </h1>
                <button class="generate-code-btn" onclick="showCodeModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/>
                    </svg>
                    Generate Code
                </button>
            </div>

            <div class="status-section">
                <div id="status" class="status">
                    <span class="status-indicator"></span>
                    <span class="status-text">Disconnected</span>
                </div>
                <button id="connectBtn" class="secondary-btn">
                    Connect to Server
                </button>
            </div>

            <div class="server-url-container">
                <label class="setting-label">Server URL:</label>
                <input
                    type="text"
                    id="serverUrl"
                    class="server-url-input"
                    value="ws://localhost:3006"
                    placeholder="ws://localhost:3006"
                >
            </div>
        </div>

        <div class="main-grid">
            <!-- Embedding Creation -->
            <div class="card">
                <h2>Create Embeddings</h2>
                
                <div class="input-section">
                    <div class="settings-grid">
                        <div class="setting-group">
                            <label class="setting-label">Model</label>
                            <select id="modelSelect">
                                <option value="text-embedding-3-small" selected>OpenAI Small (1536d)</option>
                                <option value="text-embedding-3-large">OpenAI Large (3072d)</option>
                                <option value="text-embedding-ada-002">OpenAI Ada v2 (1536d)</option>
                                <option value="gemini-embedding-exp-03-07">Gemini Experimental (768d)</option>
                            </select>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">Dimensions (optional)</label>
                            <select id="dimensionsSelect">
                                <option value="">Model Default</option>
                                <option value="256">256</option>
                                <option value="512">512</option>
                                <option value="768">768</option>
                                <option value="1024">1024</option>
                                <option value="1536">1536</option>
                                <option value="3072">3072</option>
                            </select>
                        </div>
                    </div>

                    <h3>Text Inputs</h3>
                    <div class="text-inputs" id="textInputs">
                        <div class="text-input-wrapper">
                            <input type="text" placeholder="Enter text to embed..." value="The quick brown fox jumps over the lazy dog">
                            <button class="icon-btn" onclick="removeTextInput(this)">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="controls">
                        <button class="secondary-btn" onclick="addTextInput()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                            </svg>
                            Add Text
                        </button>
                        <button id="embedBtn" class="primary-btn" onclick="createEmbeddings()" disabled>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M14.5 2.5L3 14l1.5 1.5L16 4zm5 0L8 14l1.5 1.5L21 4zM19.5 7.5L8 19l1.5 1.5L21 8z"/>
                            </svg>
                            Generate Embeddings
                        </button>
                    </div>

                    <div class="progress-bar" id="embedProgress">
                        <div class="progress-fill" id="embedProgressFill"></div>
                    </div>
                </div>

                <div class="examples-section">
                    <strong>Example Sets:</strong>
                    <button class="example-btn" onclick="loadExampleSet('similar')">Similar Sentences</button>
                    <button class="example-btn" onclick="loadExampleSet('different')">Different Topics</button>
                    <button class="example-btn" onclick="loadExampleSet('languages')">Multiple Languages</button>
                    <button class="example-btn" onclick="loadExampleSet('semantic')">Semantic Variations</button>
                </div>

                <div id="embedError"></div>
            </div>

            <!-- Stored Embeddings -->
            <div class="card">
                <h2>Stored Embeddings</h2>
                
                <div class="controls" style="margin-bottom: 16px;">
                    <button class="secondary-btn" onclick="refreshStore()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                        Refresh
                    </button>
                    <button class="danger-btn" onclick="clearStore()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                        Clear All
                    </button>
                    <button class="primary-btn" onclick="analyzeSelected()" id="analyzeBtn" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                        </svg>
                        Analyze Selected
                    </button>
                </div>

                <div class="embeddings-list" id="embeddingsList">
                    <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
                        No embeddings yet. Create some to get started!
                    </p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalEmbeddings">0</div>
                        <div class="stat-label">Total Embeddings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="selectedCount">0</div>
                        <div class="stat-label">Selected</div>
                    </div>
                </div>
            </div>

            <!-- Similarity Search -->
            <div class="card full-width">
                <h2>Similarity Search</h2>
                
                <div class="search-section">
                    <div class="search-input-wrapper">
                        <input
                            type="text"
                            id="searchQuery"
                            placeholder="Enter text to find similar embeddings..."
                            onkeydown="if(event.key === 'Enter') performSearch()"
                        >
                        <select id="searchModel">
                            <option value="text-embedding-3-small">OpenAI Small</option>
                            <option value="text-embedding-3-large">OpenAI Large</option>
                            <option value="text-embedding-ada-002">OpenAI Ada v2</option>
                            <option value="gemini-embedding-exp-03-07">Gemini</option>
                        </select>
                        <button class="primary-btn" onclick="performSearch()" id="searchBtn" disabled>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                            </svg>
                            Search
                        </button>
                    </div>

                    <div class="search-results" id="searchResults"></div>
                </div>
            </div>

            <!-- Analysis Results -->
            <div class="card full-width" id="analysisCard" style="display: none;">
                <h2>Embedding Analysis</h2>
                <div class="analysis-section">
                    <div class="analysis-content" id="analysisContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Code Generation Modal -->
    <div id="codeModal" class="modal-overlay" onclick="if(event.target === this) hideCodeModal()">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Generated Code</h2>
                <button class="modal-close" onclick="hideCodeModal()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
            <div class="modal-tabs-section">
                <div class="code-tabs">
                    <button class="code-tab active" onclick="switchCodeTab('server')">Server Code</button>
                    <button class="code-tab" onclick="switchCodeTab('client')">Client Code</button>
                </div>
            </div>
            <div class="modal-body">
                <div id="serverCode" class="code-container">
                    <button class="copy-button" onclick="copyCode('server')">Copy</button>
                    <pre id="serverCodeContent"></pre>
                </div>
                <div id="clientCode" class="code-container" style="display: none;">
                    <button class="copy-button" onclick="copyCode('client')">Copy</button>
                    <pre id="clientCodeContent"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management
        let ws = null;
        let isConnected = false;
        let isProcessing = false;
        let storedEmbeddings = [];
        let selectedEmbeddings = new Set();

        // Example sets
        const exampleSets = {
            similar: [
                "The cat sat on the mat",
                "A feline rested on the rug",
                "The kitty was lying on the carpet",
                "A cat positioned itself on the floor covering"
            ],
            different: [
                "Quantum computing uses qubits for calculations",
                "The recipe requires two cups of flour",
                "Stock markets closed higher today",
                "The mountain peak was covered in snow"
            ],
            languages: [
                "Hello, how are you?",
                "Bonjour, comment allez-vous?",
                "Hola, ¿cómo estás?",
                "你好，你好吗？"
            ],
            semantic: [
                "The bank is by the river",
                "I need to go to the bank to deposit money",
                "The airplane will bank to the left",
                "We sat on the bank watching the sunset"
            ]
        };

        // Initialize
        document.getElementById('connectBtn').addEventListener('click', () => {
            if (isConnected) {
                disconnect();
            } else {
                connect();
            }
        });

        // Auto-connect on load
        window.addEventListener('load', () => {
            // Always connect immediately
            setTimeout(connect, 500);
        });

        // Listen for messages from parent frame (kept for potential future use)
        window.addEventListener('message', (event) => {
            if (event.data.type === 'updateWsUrl' && event.data.url) {
                console.log('Updating WebSocket URL from parent:', event.data.url);
                
                // Update the server URL input
                document.getElementById('serverUrl').value = event.data.url;
                
                // If connected, disconnect and reconnect with new URL
                if (isConnected) {
                    disconnect();
                    setTimeout(() => {
                        connect();
                    }, 100);
                }
            }
        });

        // Connect to WebSocket server
        function connect() {
            try {
                updateStatus('connecting', 'Connecting to server...');

                const serverUrl = document.getElementById('serverUrl').value;
                ws = new WebSocket(serverUrl);

                ws.onopen = () => {
                    updateStatus('connected', 'Connected to server');
                    isConnected = true;
                    document.getElementById('connectBtn').textContent = 'Disconnect';
                    document.getElementById('embedBtn').disabled = false;
                    document.getElementById('searchBtn').disabled = false;
                    refreshStore();
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleServerMessage(data);
                };

                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    showError('Connection error occurred', 'embedError');
                };

                ws.onclose = () => {
                    updateStatus('disconnected', 'Disconnected from server');
                    isConnected = false;
                    isProcessing = false;
                    document.getElementById('connectBtn').textContent = 'Connect to Server';
                    document.getElementById('embedBtn').disabled = true;
                    document.getElementById('searchBtn').disabled = true;
                };

            } catch (error) {
                console.error('Connection error:', error);
                showError(error.message, 'embedError');
                updateStatus('error', 'Failed to connect');
            }
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // Handle server messages
        function handleServerMessage(data) {
            switch (data.type) {
                case 'connected':
                    console.log('Connected with ID:', data.connectionId);
                    if (data.storeCount > 0) {
                        console.log(`Server has ${data.storeCount} stored embeddings`);
                    }
                    break;

                case 'embed_start':
                    isProcessing = true;
                    document.getElementById('embedBtn').disabled = true;
                    document.getElementById('embedProgress').classList.add('active');
                    document.getElementById('embedProgressFill').style.width = '0%';
                    break;

                case 'embed_progress':
                    const progress = (data.current / data.total) * 100;
                    document.getElementById('embedProgressFill').style.width = `${progress}%`;
                    break;

                case 'embed_complete':
                    isProcessing = false;
                    document.getElementById('embedBtn').disabled = false;
                    document.getElementById('embedProgress').classList.remove('active');
                    
                    console.log(`Generated ${data.embeddings.length} embeddings in ${data.duration.toFixed(2)}s`);
                    console.log(`Average time: ${data.averageTime.toFixed(3)}s per embedding`);
                    
                    refreshStore();
                    clearTextInputs();
                    break;

                case 'store_data':
                    storedEmbeddings = data.embeddings;
                    renderEmbeddings();
                    break;

                case 'search_start':
                    document.getElementById('searchResults').innerHTML = '<p style="color: var(--text-secondary);">Searching...</p>';
                    break;

                case 'search_complete':
                    renderSearchResults(data.results);
                    break;

                case 'analyze_complete':
                    renderAnalysis(data);
                    break;

                case 'store_cleared':
                    storedEmbeddings = [];
                    selectedEmbeddings.clear();
                    renderEmbeddings();
                    break;

                case 'embedding_deleted':
                    selectedEmbeddings.delete(data.id);
                    refreshStore();
                    break;

                case 'error':
                    showError(data.error, 'embedError');
                    isProcessing = false;
                    document.getElementById('embedBtn').disabled = false;
                    document.getElementById('embedProgress').classList.remove('active');
                    break;
            }
        }

        // Create embeddings
        function createEmbeddings() {
            if (!isConnected || isProcessing) return;

            const inputs = document.querySelectorAll('#textInputs input[type="text"]');
            const texts = Array.from(inputs)
                .map(input => input.value.trim())
                .filter(text => text.length > 0);

            if (texts.length === 0) {
                showError('Please enter at least one text', 'embedError');
                return;
            }

            const model = document.getElementById('modelSelect').value;
            const dimensions = document.getElementById('dimensionsSelect').value;

            ws.send(JSON.stringify({
                type: 'embed',
                texts,
                model,
                ...(dimensions && { dimensions: parseInt(dimensions) })
            }));
        }

        // Perform similarity search
        function performSearch() {
            if (!isConnected) return;

            const query = document.getElementById('searchQuery').value.trim();
            if (!query) {
                showError('Please enter a search query', 'searchResults');
                return;
            }

            const model = document.getElementById('searchModel').value;

            ws.send(JSON.stringify({
                type: 'search',
                query,
                model,
                topK: 5
            }));
        }

        // Analyze selected embeddings
        function analyzeSelected() {
            if (!isConnected || selectedEmbeddings.size < 2) return;

            ws.send(JSON.stringify({
                type: 'analyze',
                ids: Array.from(selectedEmbeddings)
            }));
        }

        // Refresh store
        function refreshStore() {
            if (!isConnected) return;
            ws.send(JSON.stringify({ type: 'get_store' }));
        }

        // Clear store
        function clearStore() {
            if (!isConnected) return;
            if (confirm('Are you sure you want to clear all embeddings?')) {
                ws.send(JSON.stringify({ type: 'clear' }));
            }
        }

        // Render embeddings
        function renderEmbeddings() {
            const container = document.getElementById('embeddingsList');
            
            if (storedEmbeddings.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">No embeddings yet. Create some to get started!</p>';
                document.getElementById('totalEmbeddings').textContent = '0';
                updateSelectedCount();
                return;
            }

            container.innerHTML = storedEmbeddings.map(emb => `
                <div class="embedding-item ${selectedEmbeddings.has(emb.id) ? 'selected' : ''}" 
                     onclick="toggleSelection('${emb.id}')"
                     data-id="${emb.id}">
                    <div class="embedding-header">
                        <div class="embedding-text">${escapeHtml(emb.text)}</div>
                        <button class="icon-btn" onclick="deleteEmbedding('${emb.id}', event)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="embedding-meta">
                        <span>Model: ${emb.model}</span>
                        <span>Dimensions: ${emb.dimensions}</span>
                        <span>Created: ${new Date(emb.timestamp).toLocaleTimeString()}</span>
                    </div>
                </div>
            `).join('');

            document.getElementById('totalEmbeddings').textContent = storedEmbeddings.length;
            updateSelectedCount();
        }

        // Render search results
        function renderSearchResults(results) {
            const container = document.getElementById('searchResults');
            
            if (!results || results.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No similar embeddings found.</p>';
                return;
            }

            container.innerHTML = results.map(result => `
                <div class="result-item">
                    <div class="result-header">
                        <div>
                            <div style="font-weight: 500; margin-bottom: 4px;">${escapeHtml(result.text)}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">
                                Model: ${result.model} | Created: ${new Date(result.timestamp).toLocaleTimeString()}
                            </div>
                        </div>
                        <div class="similarity-score">${(result.similarity * 100).toFixed(1)}%</div>
                    </div>
                    <div class="similarity-bar">
                        <div class="similarity-fill" style="width: ${result.similarity * 100}%"></div>
                    </div>
                </div>
            `).join('');
        }

        // Render analysis
        function renderAnalysis(data) {
            console.log('Rendering analysis:', data);
            const analysisCard = document.getElementById('analysisCard');
            const analysisContent = document.getElementById('analysisContent');
            
            if (!data.analysis) {
                console.warn('No analysis text in data:', data);
                analysisContent.textContent = 'No analysis available.';
            } else {
                analysisContent.textContent = data.analysis;
            }
            
            analysisCard.style.display = 'block';
            
            // Scroll to analysis
            analysisCard.scrollIntoView({ behavior: 'smooth' });
        }

        // Toggle selection
        function toggleSelection(id) {
            if (selectedEmbeddings.has(id)) {
                selectedEmbeddings.delete(id);
            } else {
                selectedEmbeddings.add(id);
            }
            
            const item = document.querySelector(`[data-id="${id}"]`);
            if (item) {
                item.classList.toggle('selected');
            }
            
            updateSelectedCount();
        }

        // Update selected count
        function updateSelectedCount() {
            const count = selectedEmbeddings.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('analyzeBtn').disabled = count < 2;
        }

        // Delete embedding
        function deleteEmbedding(id, event) {
            event.stopPropagation();
            if (!isConnected) return;
            
            ws.send(JSON.stringify({
                type: 'delete',
                id
            }));
        }

        // Text input management
        function addTextInput() {
            const wrapper = document.createElement('div');
            wrapper.className = 'text-input-wrapper';
            wrapper.innerHTML = `
                <input type="text" placeholder="Enter text to embed...">
                <button class="icon-btn" onclick="removeTextInput(this)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            `;
            document.getElementById('textInputs').appendChild(wrapper);
            wrapper.querySelector('input').focus();
        }

        function removeTextInput(button) {
            const wrapper = button.closest('.text-input-wrapper');
            if (document.querySelectorAll('.text-input-wrapper').length > 1) {
                wrapper.remove();
            }
        }

        function clearTextInputs() {
            const container = document.getElementById('textInputs');
            container.innerHTML = `
                <div class="text-input-wrapper">
                    <input type="text" placeholder="Enter text to embed...">
                    <button class="icon-btn" onclick="removeTextInput(this)">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </button>
                </div>
            `;
        }

        // Load example set
        function loadExampleSet(setName) {
            const texts = exampleSets[setName];
            if (!texts) return;

            const container = document.getElementById('textInputs');
            container.innerHTML = texts.map(text => `
                <div class="text-input-wrapper">
                    <input type="text" value="${escapeHtml(text)}">
                    <button class="icon-btn" onclick="removeTextInput(this)">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        // Update status
        function updateStatus(state, text) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${state}`;
            statusEl.querySelector('.status-text').textContent = text;
        }

        // Show error
        function showError(message, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="error-message">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                    ${message}
                </div>
            `;

            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (container.innerHTML.includes(message)) {
                    container.innerHTML = '';
                }
            }, 5000);
        }

        // Utility function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Code generation functions
        function showCodeModal() {
            const model = document.getElementById('modelSelect').value;
            const dimensions = document.getElementById('dimensionsSelect').value;

            // Generate server code
            const serverCode = generateServerCode(model, dimensions);
            document.getElementById('serverCodeContent').textContent = serverCode;

            // Generate client code
            const clientCode = generateClientCode(model, dimensions);
            document.getElementById('clientCodeContent').textContent = clientCode;

            // Show modal
            document.getElementById('codeModal').classList.add('active');
        }

        function hideCodeModal() {
            document.getElementById('codeModal').classList.remove('active');
        }

        function switchCodeTab(tab) {
            const tabs = document.querySelectorAll('.code-tab');
            const containers = document.querySelectorAll('.code-container');

            tabs.forEach(t => t.classList.remove('active'));
            containers.forEach(c => c.style.display = 'none');

            if (tab === 'server') {
                tabs[0].classList.add('active');
                document.getElementById('serverCode').style.display = 'block';
            } else {
                tabs[1].classList.add('active');
                document.getElementById('clientCode').style.display = 'block';
            }
        }

        function copyCode(type) {
            const content = type === 'server'
                ? document.getElementById('serverCodeContent').textContent
                : document.getElementById('clientCodeContent').textContent;

            navigator.clipboard.writeText(content).then(() => {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.classList.add('copied');

                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            });
        }

        function generateServerCode(model, dimensions) {
            const dimensionsLine = dimensions ? `dimensions: ${dimensions},` : '';
            
            return `import { ensembleEmbed } from '@just-every/ensemble';

const texts = [
    'The quick brown fox jumps over the lazy dog',
    'Machine learning is transforming technology',
    'Embeddings capture semantic meaning in text'
];

const options = {
    model: '${model}',${dimensionsLine ? '\n    ' + dimensionsLine : ''}
};

// Generate embeddings
try {
    const embeddings = await ensembleEmbed(texts, options);
    
    console.log('Generated embeddings:');
    embeddings.forEach((embedding, index) => {
        console.log(\`Text \${index + 1}: \${texts[index]}\`);
        console.log(\`Embedding: [\${embedding.slice(0, 5).join(', ')}...] (\${embedding.length}d)\`);
        console.log('---');
    });
    
    // Calculate similarity between first two embeddings
    const similarity = cosineSimilarity(embeddings[0], embeddings[1]);
    console.log(\`Similarity between first two texts: \${similarity.toFixed(4)}\`);
    
} catch (error) {
    console.error('Error generating embeddings:', error);
}

// Helper function to calculate cosine similarity
function cosineSimilarity(a, b) {
    const dotProduct = a.reduce((sum, val, i) => sum + val * b[i], 0);
    const magnitudeA = Math.sqrt(a.reduce((sum, val) => sum + val * val, 0));
    const magnitudeB = Math.sqrt(b.reduce((sum, val) => sum + val * val, 0));
    return dotProduct / (magnitudeA * magnitudeB);
}`;
        }

        function generateClientCode(model, dimensions) {
            const dimensionsLine = dimensions ? `dimensions: ${dimensions},` : '';
            
            return `// Embedding similarity search example
import { ensembleEmbed } from '@just-every/ensemble';

class EmbeddingSearchEngine {
    constructor() {
        this.embeddings = [];
        this.texts = [];
    }

    async addDocument(text) {
        const embedding = await ensembleEmbed([text], {
            model: '${model}',${dimensionsLine ? '\n            ' + dimensionsLine : ''}
        });
        
        this.texts.push(text);
        this.embeddings.push(embedding[0]);
        
        console.log(\`Added document: "\${text.substring(0, 50)}..."\`);
    }

    async search(query, topK = 5) {
        if (this.embeddings.length === 0) {
            throw new Error('No documents indexed');
        }

        // Generate embedding for the query
        const queryEmbedding = await ensembleEmbed([query], {
            model: '${model}',${dimensionsLine ? '\n            ' + dimensionsLine : ''}
        });

        // Calculate similarities
        const similarities = this.embeddings.map((embedding, index) => ({
            text: this.texts[index],
            similarity: this.cosineSimilarity(queryEmbedding[0], embedding),
            index
        }));

        // Sort by similarity and return top results
        return similarities
            .sort((a, b) => b.similarity - a.similarity)
            .slice(0, topK);
    }

    cosineSimilarity(a, b) {
        const dotProduct = a.reduce((sum, val, i) => sum + val * b[i], 0);
        const magnitudeA = Math.sqrt(a.reduce((sum, val) => sum + val * val, 0));
        const magnitudeB = Math.sqrt(b.reduce((sum, val) => sum + val * val, 0));
        return dotProduct / (magnitudeA * magnitudeB);
    }
}

// Usage example
async function demo() {
    const searchEngine = new EmbeddingSearchEngine();
    
    // Add some documents
    await searchEngine.addDocument('Machine learning algorithms for data analysis');
    await searchEngine.addDocument('Cooking recipes for Italian cuisine');
    await searchEngine.addDocument('Deep learning neural network architectures');
    await searchEngine.addDocument('Travel guide for European destinations');
    
    // Search for similar documents
    const results = await searchEngine.search('AI and machine learning');
    
    console.log('Search results:');
    results.forEach((result, index) => {
        console.log(\`\${index + 1}. Similarity: \${result.similarity.toFixed(4)}\`);
        console.log(\`   Text: \${result.text}\`);
    });
}

// Run the demo
demo().catch(console.error);`;
        }
    </script>
</body>
</html>