<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ensemble Request Demo</title>
    <!-- Markdown renderer -->
    <script src="https://cdn.jsdelivr.net/npm/marked@14.1.2/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.9/dist/purify.min.js"></script>
    <style>
        :root {
            --primary: #1a73e8;
            --primary-dark: #1557b0;
            --success: #34a853;
            --warning: #fbbc04;
            --error: #ea4335;
            --background: #f5f5f5;
            --surface: #ffffff;
            --text: #202124;
            --text-secondary: #959595;
            --code-bg: #f8f9fa;
            --border: #e0e0e0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            gap: 20px;
            height: 100vh;
        }

        .sidebar {
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            color: var(--primary);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 28px;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .generate-code-btn {
            background: var(--surface);
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .generate-code-btn:hover {
            background: var(--primary);
            color: white;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--surface);
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        .modal-tabs-section {
            border-bottom: 1px solid var(--border);
            background: var(--surface);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            margin: 0;
            font-size: 20px;
            color: var(--text);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f0f0f0;
            color: var(--text);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .code-tabs {
            display: flex;
            gap: 8px;
            padding: 0 24px;
        }

        .code-tab {
            background: none;
            border: none;
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            border-radius: 0;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .code-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .code-container {
            position: relative;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            overflow-x: auto;
        }

        .code-container pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .copy-button {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-button:hover {
            background: var(--primary-dark);
        }

        .copy-button.copied {
            background: var(--success);
        }

        h2 {
            margin-bottom: 16px;
            color: var(--text);
            font-size: 18px;
        }

        .status-section {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 16px;
            font-weight: 500;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e0e0e0;
            transition: all 0.3s;
        }

        .status.connected .status-indicator {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .status.connecting .status-indicator {
            background: var(--warning);
            animation: pulse 1s infinite;
        }

        .status.error .status-indicator {
            background: var(--error);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.2); }
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 0;
        }

        .message {
            display: flex;
            flex-direction: column;
            gap: 4px;
            animation: fadeIn 0.3s ease;
        }

        .message-row {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
            margin-top: 2px; /* Slightly offset to align with first line of text */
        }

        .message.user .message-avatar {
            background: var(--primary);
        }

        .message.assistant .message-avatar {
            background: var(--success);
        }

        .message.system .message-avatar {
            background: var(--text-secondary);
        }

        .message-content {
            flex: 1;
            word-wrap: break-word;
            position: relative;
        }

        .message-metadata {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 400;
            padding: 0;
            margin: 0 0 0 48px; /* Offset by avatar width + gap */
        }

        .message-body {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px 16px;
        }

        .message-content pre {
            background: var(--code-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .message-content code {
            background: var(--code-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
        }

        /* Markdown content styling */
        .message-content .content h1,
        .message-content .content h2,
        .message-content .content h3,
        .message-content .content h4,
        .message-content .content h5,
        .message-content .content h6 {
            margin: 16px 0 8px 0;
            color: var(--text);
            font-weight: 600;
        }

        .message-content .content h1 { font-size: 1.5em; }
        .message-content .content h2 { font-size: 1.3em; }
        .message-content .content h3 { font-size: 1.1em; }

        .message-content .content p {
            margin: 8px 0;
            line-height: 1.6;
        }

        .message-content .content ul,
        .message-content .content ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .message-content .content li {
            margin: 4px 0;
        }

        .message-content .content blockquote {
            border-left: 4px solid var(--primary);
            padding-left: 16px;
            margin: 16px 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        .message-content .content table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
        }

        .message-content .content th,
        .message-content .content td {
            border: 1px solid var(--border);
            padding: 8px 12px;
            text-align: left;
        }

        .message-content .content th {
            background: #f0f0f0;
            font-weight: 600;
        }

        .typing-indicator-modern {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .typing-dots {
            display: flex;
            gap: 2px;
        }

        .typing-dots span {
            width: 4px;
            height: 4px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        .tool-call {
            background: #e8f0fe;
            border: 1px solid #c2d9ff;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            font-family: monospace;
            font-size: 14px;
        }

        .tool-result {
            background: #e6f4ea;
            border: 1px solid #ceead6;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 12px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; transform: scale(0.8); }
            30% { opacity: 1; transform: scale(1); }
        }

        .input-section {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: var(--surface);
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        textarea {
            flex: 1;
            min-height: 60px;
            max-height: 200px;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .primary-btn {
            background: var(--primary);
            color: white;
        }

        .primary-btn:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .secondary-btn {
            background: #e8e8e8;
            color: var(--text);
        }

        .secondary-btn:hover:not(:disabled) {
            background: #d8d8d8;
        }

        .danger-btn {
            background: var(--error);
            color: white;
        }

        .danger-btn:hover:not(:disabled) {
            background: #c5221f;
        }

        .settings-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .setting-label {
            font-weight: 500;
            font-size: 14px;
            color: var(--text-secondary);
        }

        select, input[type="number"] {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            background-color: var(--surface);
            cursor: pointer;
            transition: border-color 0.2s;
        }

        select:hover, input[type="number"]:hover {
            border-color: #c0c0c0;
        }

        select:focus, input[type="number"]:focus {
            outline: none;
            border-color: var(--primary);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        .slider-value {
            min-width: 50px;
            text-align: right;
            font-weight: 500;
        }

        .stats-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .tools-section {
            margin-top: 16px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .tools-list {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .tool-item {
            font-size: 14px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .tool-name {
            font-weight: 600;
            color: var(--primary);
        }

        .tool-description {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .examples-section {
            margin-top: 20px;
        }

        .example-btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid var(--primary);
            color: var(--primary);
            font-size: 14px;
            text-align: left;
            justify-content: flex-start;
        }

        .example-btn:hover {
            background: var(--primary);
            color: white;
        }

        .server-url-container {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .server-url-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            margin-top: 8px;
        }

        .advanced-section {
            margin: 10px 0;
            padding: 16px 0;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        .advanced-toggle {
            width: 100%;
            background: none;
            border: none;
            padding: 8px 0;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            text-align: left;
            transition: color 0.2s;
        }

        .advanced-toggle:hover {
            color: var(--text);
        }

        .advanced-toggle .chevron {
            transition: transform 0.2s;
        }

        .advanced-toggle.expanded .chevron {
            transform: rotate(180deg);
        }

        .advanced-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: #f9f9f9;
        }

        .advanced-content.expanded {
            max-height: 600px;
            padding: 10px;
        }

        .advanced-content .checkbox-group {
            margin-bottom: 20px;
            padding-bottom: 4px;
        }

        .advanced-content .setting-group {
            margin-bottom: 20px;
        }

        .advanced-content .setting-group:last-child {
            margin-bottom: 0;
        }

        .error-message {
            background: #fce8e6;
            color: var(--error);
            padding: 12px 16px;
            border-radius: 8px;
            margin: 16px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
            }

            .sidebar {
                width: 100%;
            }

            .messages-container {
                min-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="card">
                <h2>Settings</h2>
                <div class="settings-section">
                    <div class="setting-group">
                        <label class="setting-label">Model</label>
                        <select id="modelSelect">
                            <option value="">Use Model Class</option>
                            <!-- Models will be populated dynamically -->
                        </select>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">Model Class</label>
                        <select id="modelClassSelect">
                            <!-- Model classes will be populated dynamically -->
                        </select>
                    </div>

                    <div class="advanced-section">
                        <button type="button" class="advanced-toggle" onclick="toggleAdvanced()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="chevron">
                                <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                            </svg>
                            Advanced Settings
                        </button>
                        <div class="advanced-content" id="advancedContent">
                            <div class="checkbox-group">
                                <input type="checkbox" id="enableTools" checked>
                                <label for="enableTools" class="setting-label">Enable Tool Calling</label>
                            </div>

                            <div class="setting-group">
                                <label class="setting-label">Max Tokens</label>
                                <input type="number" id="maxTokens" value="1000" min="1" max="8192">
                            </div>

                            <div class="setting-group">
                                <label class="setting-label">Temperature</label>
                                <div class="slider-container">
                                    <input type="range" id="temperature" min="0" max="2" step="0.1" value="1.0">
                                    <span class="slider-value" id="temperatureValue">1.0</span>
                                </div>
                            </div>

                            <div class="setting-group">
                                <label class="setting-label">Top P</label>
                                <div class="slider-container">
                                    <input type="range" id="topP" min="0" max="1" step="0.01" value="1.0">
                                    <span class="slider-value" id="topPValue">1.0</span>
                                </div>
                            </div>

                            <div class="setting-group">
                                <label class="setting-label">Frequency Penalty</label>
                                <div class="slider-container">
                                    <input type="range" id="frequencyPenalty" min="-2" max="2" step="0.1" value="0">
                                    <span class="slider-value" id="frequencyPenaltyValue">0</span>
                                </div>
                            </div>

                            <div class="setting-group">
                                <label class="setting-label">Presence Penalty</label>
                                <div class="slider-container">
                                    <input type="range" id="presencePenalty" min="-2" max="2" step="0.1" value="0">
                                    <span class="slider-value" id="presencePenaltyValue">0</span>
                                </div>
                            </div>

                            <div class="setting-group">
                                <label class="setting-label">Seed (for reproducible outputs)</label>
                                <input type="number" id="seed" placeholder="Leave empty for random">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="stats-section">
                    <div class="stat-card">
                        <div class="stat-value" id="tokenCount">0</div>
                        <div class="stat-label">Tokens</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="costValue">$0.00</div>
                        <div class="stat-label">Cost</div>
                    </div>
                </div>

                <div class="tools-section" id="toolsSection">
                    <strong>Available Tools:</strong>
                    <div class="tools-list" id="toolsList">
                        <div class="tool-item">
                            <div class="tool-name">Loading...</div>
                            <div class="tool-description">Connecting to server...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Examples</h2>
                <div class="examples-section">
                    <button class="example-btn" onclick="sendExample('weather')">
                        ☀️ Ask about weather
                    </button>
                    <button class="example-btn" onclick="sendExample('math')">
                        🧮 Solve math problem
                    </button>
                    <button class="example-btn" onclick="sendExample('search')">
                        🔍 Search for information
                    </button>
                    <button class="example-btn" onclick="sendExample('code')">
                        💻 Write some code
                    </button>
                    <button class="example-btn" onclick="sendExample('creative')">
                        ✨ Creative writing
                    </button>
                </div>

                <div class="server-url-container">
                    <label class="setting-label">Server URL:</label>
                    <input
                        type="text"
                        id="serverUrl"
                        class="server-url-input"
                        value="ws://localhost:3005"
                        placeholder="ws://localhost:3005"
                    >
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="card chat-container">
                <div class="header-row">
                    <h1>
                        <svg width="32" height="32" viewBox="0 0 640 512" fill="currentColor">
                            <path d="M64 0C28.7 0 0 28.7 0 64L0 256c0 35.3 28.7 64 64 64l32 0 0 48c0 6.1 3.4 11.6 8.8 14.3s11.9 2.1 16.8-1.5L202.7 320 352 320c35.3 0 64-28.7 64-64l0-192c0-35.3-28.7-64-64-64L64 0zM352 352l-96 0 0 32c0 35.3 28.7 64 64 64l117.3 0 81.1 60.8c4.8 3.6 11.3 4.2 16.8 1.5s8.8-8.2 8.8-14.3l0-48 32 0c35.3 0 64-28.7 64-64l0-192c0-35.3-28.7-64-64-64l-128 0 0 128c0 53-43 96-96 96z"/>
                        </svg>
                        Ensemble Request Demo
                    </h1>
                    <button class="generate-code-btn" onclick="showCodeModal()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/>
                        </svg>
                        Generate Code
                    </button>
                </div>

                <div class="status-section">
                    <div id="status" class="status">
                        <span class="status-indicator"></span>
                        <span class="status-text">Disconnected</span>
                    </div>
                    <button id="connectBtn" class="secondary-btn">
                        Connect to Server
                    </button>
                    <button id="clearBtn" class="secondary-btn" onclick="clearChat()">
                        Clear Chat
                    </button>
                </div>

                <div class="messages-container" id="messagesContainer"></div>

                <div class="input-section">
                    <div class="input-wrapper">
                        <textarea
                            id="messageInput"
                            placeholder="Type your message..."
                            onkeydown="handleKeyPress(event)"
                        ></textarea>
                        <button id="sendBtn" class="primary-btn" onclick="sendMessage()" disabled>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                            Send
                        </button>
                        <button id="stopBtn" class="danger-btn" onclick="stopStreaming()" style="display: none;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M6 6h12v12H6z"/>
                            </svg>
                            Stop
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Code Generation Modal -->
    <div id="codeModal" class="modal-overlay" onclick="if(event.target === this) hideCodeModal()">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Generated Code</h2>
                <button class="modal-close" onclick="hideCodeModal()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
            <div class="modal-tabs-section">
                <div class="code-tabs">
                    <button class="code-tab active" onclick="switchCodeTab('server')">Server Code</button>
                    <button class="code-tab" onclick="switchCodeTab('client')">Client Code</button>
                </div>
            </div>
            <div class="modal-body">
                <div id="serverCode" class="code-container">
                    <button class="copy-button" onclick="copyCode('server')">Copy</button>
                    <pre id="serverCodeContent"></pre>
                </div>
                <div id="clientCode" class="code-container" style="display: none;">
                    <button class="copy-button" onclick="copyCode('client')">Copy</button>
                    <pre id="clientCodeContent"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management
        let ws = null;
        let isConnected = false;
        let isStreaming = false;
        let messages = [];
        let currentMessageElement = null;
        let currentMessageModel = null;
        let currentMessageClass = null;
        let totalTokens = 0;
        let totalCost = 0;
        let availableTools = [];
        let availableModels = [];
        let availableModelClasses = [];

        // Example prompts
        const examples = {
            weather: "What's the weather like in Tokyo, London, and New York? Compare the temperatures.",
            math: "Calculate the following: (15 * 23) + (sqrt(144) / 3) - 78. Show your work step by step.",
            search: "Search for information about quantum computing and its potential applications in medicine.",
            code: "Write a Python function that implements binary search on a sorted array. Include comments and example usage.",
            creative: "Write a short story about a robot who discovers it can dream. Make it philosophical and touching."
        };

        // Initialize event handlers
        document.getElementById('connectBtn').addEventListener('click', () => {
            if (isConnected) {
                disconnect();
            } else {
                connect();
            }
        });

        document.getElementById('modelSelect').addEventListener('change', (e) => {
            if (e.target.value) {
                document.getElementById('modelClassSelect').value = '';
            }
        });

        document.getElementById('modelClassSelect').addEventListener('change', (e) => {
            if (e.target.value) {
                document.getElementById('modelSelect').value = '';
            }
        });

        document.getElementById('temperature').addEventListener('input', (e) => {
            document.getElementById('temperatureValue').textContent = e.target.value;
        });

        document.getElementById('topP').addEventListener('input', (e) => {
            document.getElementById('topPValue').textContent = e.target.value;
        });

        document.getElementById('frequencyPenalty').addEventListener('input', (e) => {
            document.getElementById('frequencyPenaltyValue').textContent = e.target.value;
        });

        document.getElementById('presencePenalty').addEventListener('input', (e) => {
            document.getElementById('presencePenaltyValue').textContent = e.target.value;
        });

        // Auto-connect on load
        window.addEventListener('load', () => {
            // Always connect immediately
            setTimeout(connect, 500);
        });

        // Listen for messages from parent frame (kept for potential future use)
        window.addEventListener('message', (event) => {
            if (event.data.type === 'updateWsUrl' && event.data.url) {
                console.log('Updating WebSocket URL from parent:', event.data.url);

                // Update the server URL input
                document.getElementById('serverUrl').value = event.data.url;

                // If connected, disconnect and reconnect with new URL
                if (isConnected) {
                    disconnect();
                    setTimeout(() => {
                        connect();
                    }, 100);
                }
            }
        });

        // Connect to WebSocket server
        function connect() {
            try {
                updateStatus('connecting', 'Connecting to server...');

                const serverUrl = document.getElementById('serverUrl').value;
                ws = new WebSocket(serverUrl);

                ws.onopen = () => {
                    updateStatus('connected', 'Connected to server');
                    isConnected = true;
                    document.getElementById('connectBtn').textContent = 'Disconnect';
                    document.getElementById('sendBtn').disabled = false;
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleServerMessage(data);
                };

                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    showError('Connection error occurred');
                };

                ws.onclose = () => {
                    updateStatus('disconnected', 'Disconnected from server');
                    isConnected = false;
                    isStreaming = false;
                    document.getElementById('connectBtn').textContent = 'Connect to Server';
                    document.getElementById('sendBtn').disabled = true;
                    document.getElementById('stopBtn').style.display = 'none';
                    document.getElementById('sendBtn').style.display = 'flex';
                };

            } catch (error) {
                console.error('Connection error:', error);
                showError(error.message);
                updateStatus('error', 'Failed to connect');
            }
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // Handle server messages
        function handleServerMessage(data) {
            switch (data.type) {
                case 'connected':
                    console.log('Connected with ID:', data.connectionId);
                    if (data.availableTools) {
                        availableTools = data.availableTools;
                        updateToolsList();
                    }
                    if (data.models) {
                        availableModels = data.models;
                        populateModelSelect();
                    }
                    if (data.modelClasses) {
                        availableModelClasses = data.modelClasses;
                        populateModelClassSelect();
                    }
                    break;

                case 'agent_start':
                    // Capture the actual resolved model from the agent
                    if (data.agent) {
                        currentMessageModel = data.agent.model;
                        currentMessageClass = data.agent.modelClass;

                        // Update the metadata of the current streaming message
                        if (currentMessageElement) {
                            // currentMessageElement is messageBody
                            // Navigate: messageBody -> message-content -> message-row -> message
                            const messageContent = currentMessageElement.parentElement; // message-content
                            const messageRow = messageContent?.parentElement; // message-row
                            const message = messageRow?.parentElement; // message
                            const metadata = message?.querySelector('.message-metadata');
                            if (metadata) {
                                let metadataText = '';
                                if (currentMessageClass && currentMessageModel) {
                                    metadataText = `Class: ${currentMessageClass} • Model: ${currentMessageModel}`;
                                } else if (currentMessageClass) {
                                    metadataText = `Class: ${currentMessageClass}`;
                                } else if (currentMessageModel) {
                                    metadataText = `Model: ${currentMessageModel}`;
                                }
                                metadata.textContent = metadataText;
                            }
                        }
                    }
                    break;

                case 'stream_start':
                    isStreaming = true;
                    // Update model if server provides it, otherwise keep the one we sent
                    if (data.model) {
                        currentMessageModel = data.model;
                    }
                    document.getElementById('stopBtn').style.display = 'flex';
                    document.getElementById('sendBtn').style.display = 'none';
                    addMessage('assistant', '', true);
                    break;

                case 'message_start':
                    // Update current model if provided
                    if (data.model) {
                        currentMessageModel = data.model;
                    }
                    break;

                case 'message_delta':
                    if (currentMessageElement && data.content) {
                        // Remove typing indicator if present
                        const typingIndicator = currentMessageElement.querySelector('.typing-indicator-modern');
                        if (typingIndicator) {
                            typingIndicator.remove();
                        }

                        // Get or create content span
                        let contentSpan = currentMessageElement.querySelector('.content');
                        if (!contentSpan) {
                            contentSpan = document.createElement('div');
                            contentSpan.className = 'content';
                            currentMessageElement.appendChild(contentSpan);
                        }

                        // Append the delta content (incremental) - keep as plain text during streaming
                        contentSpan.textContent += data.content;
                    }
                    break;

                case 'message_complete':
                    if (currentMessageElement && data.content) {
                        // Ensure typing indicator is removed
                        const typingIndicator = currentMessageElement.querySelector('.typing-indicator-modern');
                        if (typingIndicator) {
                            typingIndicator.remove();
                        }

                        // Get or create content span
                        let contentSpan = currentMessageElement.querySelector('.content');
                        if (!contentSpan) {
                            contentSpan = document.createElement('div');
                            contentSpan.className = 'content';
                            currentMessageElement.appendChild(contentSpan);
                        }

                        // Render the final content as markdown
                        const html = marked.parse(data.content);
                        const sanitizedHtml = DOMPurify.sanitize(html);
                        contentSpan.innerHTML = sanitizedHtml;

                        // Add to messages history
                        messages.push({ role: 'assistant', content: data.content });
                    }
                    break;

                case 'tool_start':
                    if (currentMessageElement && data.tool_call) {
                        const toolDiv = document.createElement('div');
                        toolDiv.className = 'tool-call';

                        // Format arguments nicely
                        let formattedArgs = '';
                        try {
                            const args = typeof data.tool_call.function.arguments === 'string'
                                ? JSON.parse(data.tool_call.function.arguments)
                                : data.tool_call.function.arguments;
                            formattedArgs = JSON.stringify(args, null, 2);
                        } catch {
                            formattedArgs = data.tool_call.function.arguments || '{}';
                        }

                        toolDiv.innerHTML = `<strong>🔧 Calling ${data.tool_call.function.name}:</strong><br><pre>${formattedArgs}</pre>`;
                        currentMessageElement.appendChild(toolDiv);
                    }
                    break;

                case 'tool_done':
                    if (currentMessageElement && data.result) {
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'tool-result';

                        // Format result nicely
                        let formattedResult = data.result.output || data.result.error || 'No result';

                        // Try to parse and format JSON-like results
                        try {
                            if (formattedResult.includes('{') && formattedResult.includes('}')) {
                                // Extract JSON part and format it
                                const jsonMatch = formattedResult.match(/\{[^}]+\}/);
                                if (jsonMatch) {
                                    const jsonPart = JSON.parse(jsonMatch[0]);
                                    const nonJsonPart = formattedResult.replace(jsonMatch[0], '').trim();
                                    const formattedJson = JSON.stringify(jsonPart, null, 2);
                                    formattedResult = nonJsonPart ? `${formattedJson}\n\n${nonJsonPart}` : formattedJson;
                                }
                            }
                        } catch {
                            // Keep original format if parsing fails
                        }

                        resultDiv.innerHTML = `<strong>✅ Result:</strong><br><pre style="white-space: pre-wrap;">${formattedResult}</pre>`;
                        currentMessageElement.appendChild(resultDiv);
                    }
                    break;

                case 'cost_update':
                    if (data.usage) {
                        totalTokens += (data.usage.input_tokens || 0) + (data.usage.output_tokens || 0);
                        totalCost += data.usage.cost || 0;
                        updateStats();
                    }
                    break;

                case 'stream_complete':
                    isStreaming = false;
                    currentMessageElement = null;
                    currentMessageModel = null;
                    currentMessageClass = null;
                    document.getElementById('stopBtn').style.display = 'none';
                    document.getElementById('sendBtn').style.display = 'flex';
                    break;

                case 'stream_aborted':
                    isStreaming = false;
                    currentMessageElement = null;
                    currentMessageModel = null;
                    currentMessageClass = null;
                    document.getElementById('stopBtn').style.display = 'none';
                    document.getElementById('sendBtn').style.display = 'flex';
                    if (currentMessageElement) {
                        const abortMsg = document.createElement('div');
                        abortMsg.style.color = 'var(--error)';
                        abortMsg.style.fontStyle = 'italic';
                        abortMsg.style.marginTop = '8px';
                        abortMsg.textContent = '(Stream aborted)';
                        currentMessageElement.appendChild(abortMsg);
                    }
                    break;

                case 'error':
                    showError(data.error);
                    isStreaming = false;
                    document.getElementById('stopBtn').style.display = 'none';
                    document.getElementById('sendBtn').style.display = 'flex';
                    break;
            }
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!text || !isConnected || isStreaming) return;

            // Add user message
            addMessage('user', text);
            messages.push({ role: 'user', content: text });

            // Clear input
            input.value = '';
            input.style.height = 'auto';

            // Get settings
            const model = document.getElementById('modelSelect').value;
            const modelClass = document.getElementById('modelClassSelect').value;
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            const temperature = parseFloat(document.getElementById('temperature').value);
            const topP = parseFloat(document.getElementById('topP').value);
            const frequencyPenalty = parseFloat(document.getElementById('frequencyPenalty').value);
            const presencePenalty = parseFloat(document.getElementById('presencePenalty').value);
            const seed = document.getElementById('seed').value ? parseInt(document.getElementById('seed').value) : undefined;
            const toolsEnabled = document.getElementById('enableTools').checked;

            // Clear previous model info - will be set by agent_start event
            currentMessageModel = null;
            currentMessageClass = null;

            // Send to server
            const requestData = {
                type: 'chat',
                messages,
                ...(model && { model }),
                ...(modelClass && { modelClass }),
                maxTokens,
                toolsEnabled
            };

            // Only include advanced parameters if they differ from defaults
            if (temperature !== 1.0) requestData.temperature = temperature;
            if (topP !== 1.0) requestData.topP = topP;
            if (frequencyPenalty !== 0) requestData.frequencyPenalty = frequencyPenalty;
            if (presencePenalty !== 0) requestData.presencePenalty = presencePenalty;
            if (seed !== undefined) requestData.seed = seed;
            // Always include toolsEnabled in the request data (it's always needed)

            ws.send(JSON.stringify(requestData));
        }

        // Stop streaming
        function stopStreaming() {
            if (ws && isConnected) {
                ws.send(JSON.stringify({ type: 'stop' }));
            }
        }

        // Add message to chat
        function addMessage(role, content, isStreaming = false) {
            const container = document.getElementById('messagesContainer');

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            // Create metadata (always, for all message types)
            const metadata = document.createElement('div');
            metadata.className = 'message-metadata';

            if (role === 'user') {
                metadata.textContent = 'User';
            } else if (role === 'assistant' && (currentMessageModel || currentMessageClass || isStreaming)) {
                if (isStreaming && !currentMessageModel && !currentMessageClass) {
                    metadata.textContent = 'Responding...';
                } else {
                    // Build the metadata text
                    let metadataText = '';
                    if (currentMessageClass && currentMessageModel) {
                        metadataText = `Class: ${currentMessageClass} • Model: ${currentMessageModel}`;
                    } else if (currentMessageClass) {
                        metadataText = `Class: ${currentMessageClass}`;
                    } else if (currentMessageModel) {
                        metadataText = `Model: ${currentMessageModel}`;
                    }
                    metadata.textContent = metadataText;
                }
            }

            // Add metadata to message (above avatar)
            messageDiv.appendChild(metadata);

            // Create message row container
            const messageRow = document.createElement('div');
            messageRow.className = 'message-row';

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'U' : role === 'assistant' ? 'A' : 'S';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            // Create message body container
            const messageBody = document.createElement('div');
            messageBody.className = 'message-body';

            if (isStreaming) {
                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'typing-indicator-modern';
                typingIndicator.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                    </svg>
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                `;
                messageBody.appendChild(typingIndicator);

                currentMessageElement = messageBody;
            } else {
                // Render content as markdown for non-streaming messages
                if (role === 'assistant' && content) {
                    const contentElement = document.createElement('div');
                    contentElement.className = 'content';
                    const html = marked.parse(content);
                    const sanitizedHtml = DOMPurify.sanitize(html);
                    contentElement.innerHTML = sanitizedHtml;
                    messageBody.appendChild(contentElement);
                } else {
                    const contentElement = document.createElement('div');
                    contentElement.className = 'content';
                    contentElement.textContent = content;
                    messageBody.appendChild(contentElement);
                }
            }

            // Add message body to content div
            contentDiv.appendChild(messageBody);

            // Add avatar and content to message row
            messageRow.appendChild(avatar);
            messageRow.appendChild(contentDiv);

            // Add message row to message div
            messageDiv.appendChild(messageRow);
            container.appendChild(messageDiv);

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        // Clear chat
        function clearChat() {
            messages = [];
            totalTokens = 0;
            totalCost = 0;
            document.getElementById('messagesContainer').innerHTML = '';
            updateStats();
        }

        // Send example
        function sendExample(type) {
            const input = document.getElementById('messageInput');
            input.value = examples[type] || '';
            input.focus();

            // Auto-send if connected
            if (isConnected && !isStreaming) {
                setTimeout(sendMessage, 100);
            }
        }

        // Update status
        function updateStatus(state, text) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${state}`;
            statusEl.querySelector('.status-text').textContent = text;
        }

        // Update stats
        function updateStats() {
            document.getElementById('tokenCount').textContent = totalTokens.toLocaleString();
            document.getElementById('costValue').textContent = `$${totalCost.toFixed(4)}`;
        }

        // Update tools list
        function updateToolsList() {
            const container = document.getElementById('toolsList');
            if (!availableTools || availableTools.length === 0) {
                container.innerHTML = '<div class="tool-item"><div class="tool-description">No tools available</div></div>';
                return;
            }

            container.innerHTML = availableTools.map(tool => `
                <div class="tool-item">
                    <div class="tool-name">${tool.name}</div>
                    <div class="tool-description">${tool.description}</div>
                </div>
            `).join('');
        }

        // Populate model select dropdown
        function populateModelSelect() {
            const select = document.getElementById('modelSelect');

            // Keep the "Use Model Class" option
            select.innerHTML = '<option value="">Use Model Class</option>';

            // Filter models to only include those with text input and text output
            const textModels = availableModels.filter(model => {
                const features = model.features || {};
                const inputModalities = features.input_modality || [];
                const outputModalities = features.output_modality || [];

                return inputModalities.includes('text') && outputModalities.includes('text');
            });

            // Group filtered models by provider
            const modelsByProvider = {};
            textModels.forEach(model => {
                if (!modelsByProvider[model.provider]) {
                    modelsByProvider[model.provider] = [];
                }
                modelsByProvider[model.provider].push(model);
            });

            // Add optgroups for each provider
            Object.entries(modelsByProvider).forEach(([provider, models]) => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = provider.charAt(0).toUpperCase() + provider.slice(1);

                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    optgroup.appendChild(option);
                });

                select.appendChild(optgroup);
            });
        }

        // Populate model class select dropdown
        function populateModelClassSelect() {
            const select = document.getElementById('modelClassSelect');
            select.innerHTML = '';

            // Add model classes
            availableModelClasses.forEach((modelClass, index) => {
                const option = document.createElement('option');
                option.value = modelClass.id;
                option.textContent = modelClass.id;

                // Select 'standard' by default
                if (modelClass.id === 'standard') {
                    option.selected = true;
                }

                select.appendChild(option);
            });
        }

        // Show error
        function showError(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'error-message';
            messageDiv.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                ${message}
            `;

            const container = document.getElementById('messagesContainer');
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Handle key press
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Auto-resize textarea
        document.getElementById('messageInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        // Advanced settings toggle
        function toggleAdvanced() {
            const toggle = document.querySelector('.advanced-toggle');
            const content = document.getElementById('advancedContent');

            toggle.classList.toggle('expanded');
            content.classList.toggle('expanded');
        }

        // Code generation functions
        function showCodeModal() {
            const model = document.getElementById('modelSelect').value;
            const modelClass = document.getElementById('modelClassSelect').value;
            const maxTokens = document.getElementById('maxTokens').value;
            const temperature = document.getElementById('temperature').value;
            const topP = document.getElementById('topP').value;
            const frequencyPenalty = document.getElementById('frequencyPenalty').value;
            const presencePenalty = document.getElementById('presencePenalty').value;
            const seed = document.getElementById('seed').value;
            const toolsEnabled = document.getElementById('enableTools').checked;

            // Generate server code
            const serverCode = generateServerCode(model, modelClass, maxTokens, temperature, topP, frequencyPenalty, presencePenalty, seed, toolsEnabled);
            document.getElementById('serverCodeContent').textContent = serverCode;

            // Generate client code
            const clientCode = generateClientCode(model, modelClass, maxTokens, temperature, topP, frequencyPenalty, presencePenalty, seed, toolsEnabled);
            document.getElementById('clientCodeContent').textContent = clientCode;

            // Show modal
            document.getElementById('codeModal').classList.add('active');
        }

        function hideCodeModal() {
            document.getElementById('codeModal').classList.remove('active');
        }

        function switchCodeTab(tab) {
            const tabs = document.querySelectorAll('.code-tab');
            const containers = document.querySelectorAll('.code-container');

            tabs.forEach(t => t.classList.remove('active'));
            containers.forEach(c => c.style.display = 'none');

            if (tab === 'server') {
                tabs[0].classList.add('active');
                document.getElementById('serverCode').style.display = 'block';
            } else {
                tabs[1].classList.add('active');
                document.getElementById('clientCode').style.display = 'block';
            }
        }

        function copyCode(type) {
            const content = type === 'server'
                ? document.getElementById('serverCodeContent').textContent
                : document.getElementById('clientCodeContent').textContent;

            navigator.clipboard.writeText(content).then(() => {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.classList.add('copied');

                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            });
        }

        function generateServerCode(model, modelClass, maxTokens, temperature, topP, frequencyPenalty, presencePenalty, seed, toolsEnabled) {
            const modelLine = model ? `model: '${model}',` : `modelClass: '${modelClass}',`;

            // Build advanced parameters only if they differ from defaults
            let advancedParams = '';
            if (temperature !== '0.7') advancedParams += `\n                temperature: ${temperature},`;
            if (topP !== '1') advancedParams += `\n                topP: ${topP},`;
            if (frequencyPenalty !== '0') advancedParams += `\n                frequencyPenalty: ${frequencyPenalty},`;
            if (presencePenalty !== '0') advancedParams += `\n                presencePenalty: ${presencePenalty},`;
            if (seed) advancedParams += `\n                seed: ${seed},`;

            // Always include tools code and handling when enabled
            const toolsParam = toolsEnabled ? ', { tools }' : '';

            const toolsCode = toolsEnabled ? `
// Example tools
const tools = [
    {
        function: async ({ location }) => {
            // Mock weather API
            return \`Weather in \${location}: 22°C, partly cloudy\`;
        },
        definition: {
            type: 'function',
            function: {
                name: 'get_weather',
                description: 'Get weather for a location',
                parameters: {
                    type: 'object',
                    properties: {
                        location: { type: 'string', description: 'City name' }
                    },
                    required: ['location']
                }
            }
        }
    }
];` : '';

            return `import { WebSocketServer } from 'ws';
import { createServer } from 'http';
import express from 'express';
import { ensembleRequest } from '@just-every/ensemble';

const app = express();
const server = createServer(app);
const wss = new WebSocketServer({ server });
${toolsCode}

wss.on('connection', (ws) => {
    console.log('Client connected');

    ws.on('message', async (data) => {
        const message = JSON.parse(data.toString());

        if (message.type === 'chat') {
            const { messages } = message;

            const agent = {
                ${modelLine}
                maxTokens: ${maxTokens},${advancedParams}
            };

            try {
                for await (const event of ensembleRequest(messages, agent${toolsParam})) {
                    ws.send(JSON.stringify(event));
                }

                ws.send(JSON.stringify({ type: 'stream_complete' }));
            } catch (error) {
                ws.send(JSON.stringify({
                    type: 'error',
                    error: error.message
                }));
            }
        }
    });

    ws.on('close', () => console.log('Client disconnected'));
});

server.listen(3005, () => {
    console.log('WebSocket server running on ws://localhost:3005');
});`;
        }

        function generateClientCode(model, modelClass, maxTokens, temperature, topP, frequencyPenalty, presencePenalty, seed, toolsEnabled) {
            return `<!DOCTYPE html>
<html>
<head>
    <title>Ensemble Chat Client</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #messages {
            border: 1px solid #ccc;
            height: 400px;
            overflow-y: scroll;
            padding: 10px;
            margin-bottom: 10px;
        }
        .message { margin: 10px 0; padding: 8px; border-radius: 5px; }
        .user { background: #e3f2fd; }
        .assistant { background: #f5f5f5; }
        .tool-call { background: #fff3cd; font-family: monospace; }
        .tool-result { background: #d1f7d1; }
        input { width: 70%; padding: 8px; }
        button { padding: 8px 16px; }
    </style>
</head>
<body>
    <h1>Ensemble Chat Demo</h1>
    <div id="messages"></div>
    <input type="text" id="input" placeholder="Type a message...">
    <button onclick="sendMessage()">Send</button>

    <script>
        const ws = new WebSocket('ws://localhost:3005');
        const messages = [];
        let currentMessage = null;

        ws.onopen = () => {
            console.log('Connected to server');
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            switch (data.type) {
                case 'agent_start':
                    currentMessage = addMessage('assistant', '');
                    break;

                case 'message_delta':
                    if (currentMessage && data.content) {
                        currentMessage.textContent += data.content;
                    }
                    break;

                case 'message_complete':
                    if (data.content) {
                        currentMessage.textContent = data.content;
                        messages.push({ role: 'assistant', content: data.content });
                    }
                    break;

                case 'tool_start':
                    if (data.tool_call) {
                        addToolCall(data.tool_call.function.name, data.tool_call.function.arguments);
                    }
                    break;

                case 'tool_done':
                    if (data.result) {
                        addToolResult(data.result.output || data.result.error || 'No result');
                    }
                    break;

                case 'stream_complete':
                    currentMessage = null;
                    break;
            }
        };

        function sendMessage() {
            const input = document.getElementById('input');
            const content = input.value.trim();
            if (!content) return;

            addMessage('user', content);
            messages.push({ role: 'user', content });

            const requestData = {
                type: 'chat',
                messages: messages,
                model: ${model ? `'${model}'` : 'null'},
                modelClass: ${modelClass ? `'${modelClass}'` : 'null'},
                maxTokens: ${maxTokens},
                toolsEnabled: ${toolsEnabled}
            };

            // Only include advanced parameters if they differ from defaults
            ${temperature !== '0.7' ? `requestData.temperature = ${temperature};` : ''}
            ${topP !== '1' ? `requestData.topP = ${topP};` : ''}
            ${frequencyPenalty !== '0' ? `requestData.frequencyPenalty = ${frequencyPenalty};` : ''}
            ${presencePenalty !== '0' ? `requestData.presencePenalty = ${presencePenalty};` : ''}
            ${seed ? `requestData.seed = ${seed};` : ''}

            ws.send(JSON.stringify(requestData));

            input.value = '';
        }

        function addMessage(role, content) {
            const div = document.createElement('div');
            div.className = \`message \${role}\`;
            div.textContent = content;
            document.getElementById('messages').appendChild(div);
            div.scrollIntoView();
            return div;
        }

        function addToolCall(name, args) {
            const div = document.createElement('div');
            div.className = 'message tool-call';

            // Format arguments nicely
            let formattedArgs = '';
            try {
                const parsedArgs = typeof args === 'string' ? JSON.parse(args) : args;
                formattedArgs = JSON.stringify(parsedArgs, null, 2);
            } catch {
                formattedArgs = args || '{}';
            }

            div.innerHTML = \`🔧 Calling \${name}:<br><pre>\${formattedArgs}</pre>\`;
            document.getElementById('messages').appendChild(div);
        }

        function addToolResult(result) {
            const div = document.createElement('div');
            div.className = 'message tool-result';

            // Format result nicely
            let formattedResult = result;
            try {
                if (result.includes('{') && result.includes('}')) {
                    const jsonMatch = result.match(/\\{[^}]+\\}/);
                    if (jsonMatch) {
                        const jsonPart = JSON.parse(jsonMatch[0]);
                        const nonJsonPart = result.replace(jsonMatch[0], '').trim();
                        const formattedJson = JSON.stringify(jsonPart, null, 2);
                        formattedResult = nonJsonPart ? \`\${formattedJson}\\n\\n\${nonJsonPart}\` : formattedJson;
                    }
                }
            } catch {
                // Keep original format if parsing fails
            }

            div.innerHTML = \`✅ Result:<br><pre style="white-space: pre-wrap;">\${formattedResult}</pre>\`;
            document.getElementById('messages').appendChild(div);
        }

        // Enter key to send
        document.getElementById('input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    <\/script>
</body>
</html>`;
        }
    </script>
</body>
</html>